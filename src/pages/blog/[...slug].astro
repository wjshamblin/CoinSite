---
import BlogPost from '../../layouts/BlogPost.astro';
import { db, BlogPosts, eq } from 'astro:db';
import { marked } from 'marked';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
	return new Response('Post not found', { status: 404 });
}

const postSlug = Array.isArray(slug) ? slug.join('/') : slug;

const posts = await db.select().from(BlogPosts).where(eq(BlogPosts.slug, postSlug));
const post = posts[0];

if (!post) {
	return new Response('Post not found', { status: 404 });
}

// Render markdown content to HTML
const htmlContent = await marked(post.content);

// Helper to safely parse date
function parseDate(value: any): Date {
	const fallback = new Date();
	if (!value) return fallback;
	try {
		let date: Date;
		if (value instanceof Date) {
			date = value;
		} else if (typeof value === 'number') {
			date = new Date(value);
		} else if (typeof value === 'string') {
			const parsed = Number(value);
			date = isNaN(parsed) ? new Date(value) : new Date(parsed);
		} else {
			return fallback;
		}
		return isNaN(date.getTime()) ? fallback : date;
	} catch {
		return fallback;
	}
}

const pubDate = parseDate(post.pubDate);
const updatedDate = post.updatedDate ? parseDate(post.updatedDate) : undefined;
---

<BlogPost
	title={post.title}
	description={post.description}
	pubDate={pubDate}
	updatedDate={updatedDate}
	heroImage={post.heroImage}
>
	<Fragment set:html={htmlContent} />
</BlogPost>
