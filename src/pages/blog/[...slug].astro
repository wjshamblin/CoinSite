---
import BlogPost from '../../layouts/BlogPost.astro';
import { db, BlogPosts, eq } from 'astro:db';
import { marked } from 'marked';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
	return new Response('Post not found', { status: 404 });
}

const postSlug = Array.isArray(slug) ? slug.join('/') : slug;

const posts = await db.select().from(BlogPosts).where(eq(BlogPosts.slug, postSlug));
const post = posts[0];

if (!post) {
	return new Response('Post not found', { status: 404 });
}

// Render markdown content to HTML
const htmlContent = await marked(post.content);
---

<BlogPost
	title={post.title}
	description={post.description}
	pubDate={new Date(post.pubDate)}
	updatedDate={post.updatedDate ? new Date(post.updatedDate) : undefined}
	heroImage={post.heroImage}
>
	<Fragment set:html={htmlContent} />
</BlogPost>
