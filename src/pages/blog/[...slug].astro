---
import BlogPost from '../../layouts/BlogPost.astro';
import { db, BlogPosts, eq } from 'astro:db';
import { marked } from 'marked';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
	return new Response('Post not found', { status: 404 });
}

const postSlug = Array.isArray(slug) ? slug.join('/') : slug;

const posts = await db.select().from(BlogPosts).where(eq(BlogPosts.slug, postSlug));
const post = posts[0];

if (!post) {
	return new Response('Post not found', { status: 404 });
}

// Render markdown content to HTML
const htmlContent = await marked(post.content);

// Helper to parse dates that could be Date, number, or string timestamp
function parseDate(value: any): Date {
	if (value instanceof Date) return value;
	if (typeof value === 'number') return new Date(value);
	const parsed = Number(value);
	return isNaN(parsed) ? new Date(value) : new Date(parsed);
}

const pubDate = parseDate(post.pubDate);
const updatedDate = post.updatedDate ? parseDate(post.updatedDate) : undefined;
---

<BlogPost
	title={post.title}
	description={post.description}
	pubDate={pubDate}
	updatedDate={updatedDate}
	heroImage={post.heroImage}
>
	<Fragment set:html={htmlContent} />
</BlogPost>
