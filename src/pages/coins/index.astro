---
// All Coins page - shows every coin from all collections
import Layout from '../../layouts/Layout.astro';
import { db, Collections, Coins, Images, eq } from 'astro:db';
import { getImageUrl } from '../../lib/images';

export const prerender = false;

// Get all coins with their collection and first image
const allCoins = await db
	.select({
		id: Coins.id,
		name: Coins.name,
		slug: Coins.slug,
		year: Coins.year,
		condition: Coins.condition,
		primaryImage: Coins.primaryImage,
		collectionId: Coins.collectionId,
		collectionName: Collections.name,
		collectionSlug: Collections.slug,
	})
	.from(Coins)
	.innerJoin(Collections, eq(Coins.collectionId, Collections.id))
	.orderBy(Collections.name, Coins.name);

// Get first image for each coin from Images table
const coinImages = new Map();
for (const coin of allCoins) {
	const images = await db
		.select()
		.from(Images)
		.where(eq(Images.coinId, coin.id))
		.orderBy(Images.sortOrder)
		.limit(1);
	if (images.length > 0) {
		coinImages.set(coin.id, images[0].filename);
	}
}

// Helper to get thumbnail URL - uses coin.primaryImage first, falls back to first image from Images table
function getThumbnailUrl(coin: typeof allCoins[0]): string | null {
	if (coin.primaryImage) {
		return getImageUrl(coin.primaryImage, 'coins');
	}
	const imageFromTable = coinImages.get(coin.id);
	if (imageFromTable) {
		return getImageUrl(imageFromTable, 'coins');
	}
	return null;
}
---

<Layout title="All Coins">
	<div class="page-header">
		<span class="gold-accent"></span>
		<h1>All Coins</h1>
		<p class="page-description">
			Browse our complete collection of {allCoins.length} coins across all categories
		</p>
	</div>

	<div class="coins-grid">
		{allCoins.map((coin) => {
			const thumbnailUrl = getThumbnailUrl(coin);
			return (
				<a href={`/collections/${coin.collectionSlug}/${coin.slug}`} class="coin-card">
					<div class="card-image-wrapper">
						{thumbnailUrl ? (
							<img
								src={thumbnailUrl}
								alt={coin.name}
								width="300"
								height="240"
								class="card-image"
								loading="lazy"
							/>
						) : (
							<div class="no-image">No Image</div>
						)}
						<div class="card-overlay"></div>
					</div>
					<div class="card-content">
						<h3>{coin.name}</h3>
						<div class="coin-meta">
							{coin.year && <span class="year">{coin.year}</span>}
							{coin.condition && <span class="condition">{coin.condition}</span>}
						</div>
						<span class="collection-tag">{coin.collectionName}</span>
					</div>
				</a>
			);
		})}
	</div>
</Layout>

<style>
	.page-header {
		text-align: center;
		margin-bottom: 3rem;
	}

	.page-header h1 {
		margin: 1rem 0 0.75rem;
	}

	.page-description {
		color: rgb(var(--gray));
		font-size: 1.125rem;
		max-width: 550px;
		margin: 0 auto;
	}

	.coins-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
		gap: 1.5rem;
	}

	.coin-card {
		display: block;
		background: white;
		border-radius: 12px;
		overflow: hidden;
		text-decoration: none;
		color: inherit;
		box-shadow: var(--shadow-sm);
		transition: all var(--transition-base);
	}

	.coin-card:hover {
		transform: translateY(-4px);
		box-shadow: var(--shadow-lg);
	}

	.card-image-wrapper {
		position: relative;
		overflow: hidden;
		background: #f5f5f0;
	}

	.card-image {
		width: 100%;
		height: 200px;
		object-fit: contain;
		transition: transform var(--transition-slow);
		padding: 0.5rem;
	}

	.coin-card:hover .card-image {
		transform: scale(1.05);
	}

	.no-image {
		width: 100%;
		height: 200px;
		display: flex;
		align-items: center;
		justify-content: center;
		color: rgb(var(--gray-light));
		font-size: 0.875rem;
	}

	.card-overlay {
		position: absolute;
		inset: 0;
		background: linear-gradient(to top, rgba(15, 23, 42, 0.5) 0%, transparent 50%);
		opacity: 0;
		transition: opacity var(--transition-base);
		pointer-events: none;
	}

	.coin-card:hover .card-overlay {
		opacity: 1;
	}

	.card-content {
		padding: 1rem 1.25rem 1.25rem;
	}

	.card-content h3 {
		font-size: 1rem;
		margin-bottom: 0.5rem;
		color: var(--navy);
		line-height: 1.3;
	}

	.coin-meta {
		display: flex;
		gap: 0.75rem;
		margin-bottom: 0.75rem;
		font-size: 0.8125rem;
		color: rgb(var(--gray));
	}

	.year {
		font-weight: 600;
		color: var(--gold-dark);
	}

	.collection-tag {
		display: inline-block;
		font-size: 0.75rem;
		padding: 0.25rem 0.5rem;
		background: var(--cream);
		border-radius: 4px;
		color: rgb(var(--gray));
		border: 1px solid rgba(212, 175, 55, 0.2);
	}

	@media (max-width: 768px) {
		.coins-grid {
			grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
			gap: 1rem;
		}

		.card-image {
			height: 140px;
		}

		.card-content {
			padding: 0.75rem 1rem;
		}

		.card-content h3 {
			font-size: 0.875rem;
		}
	}
</style>
